# WebSocket代理架构图

## 1. 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        Toyou Proxy                              │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                    中间件链 (Middleware Chain)               │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐   │ │
│  │  │   Auth      │ │   Logging   │ │    WebSocket        │   │ │
│  │  │ Middleware  │ │ Middleware  │ │   Middleware        │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                   请求路由 (Request Routing)                │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐   │ │
│  │  │   HTTP      │ │     SSE     │ │    WebSocket        │   │ │
│  │  │  Requests   │ │  Requests   │ │   Requests          │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────┐ │
│  │                   代理处理器 (Proxy Handlers)               │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐   │ │
│  │  │   HTTP      │ │     SSE     │ │    WebSocket        │   │ │
│  │  │   Proxy     │ │   Proxy     │ │     Proxy            │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────────┘   │ │
│  └─────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
        │                   │                   │
        ▼                   ▼                   ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────────────┐
│ HTTP Server │   │ SSE Server  │ │ WebSocket Server     │
└─────────────┘   └─────────────┘   └─────────────────────┘
```

## 2. WebSocket代理详细流程

```
客户端请求 (HTTP with WebSocket Upgrade Headers)
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│                   Toyou Proxy                               │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                中间件链处理                              │ │
│  │  1. 请求接收                                             │ │
│  │  2. WebSocket检测 (检测Upgrade头)                        │ │
│  │  3. 认证中间件 (可选)                                    │ │
│  │  4. 日志中间件                                            │ │
│  │  5. WebSocket中间件 (连接跟踪、Origin验证)              │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                协议升级处理                              │ │
│  │  1. 验证WebSocket升级请求                                │ │
│  │  2. 确定目标WebSocket服务                                │ │
│  │  3. 连接后端WebSocket服务器                               │ │
│  │  4. 完成客户端升级握手                                    │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                数据转发                                  │ │
│  │  ┌─────────────────┐    ┌─────────────────┐              │ │
│  │  │   客户端连接    │◄──►│   后端连接      │              │ │
│  │  │   WebSocket     │    │   WebSocket     │              │ │
│  │  └─────────────────┘    └─────────────────┘              │ │
│  │  ┌─────────────────┐    ┌─────────────────┐              │ │
│  │  │   数据读取      │    │   数据写入      │              │ │
│  │  │   数据写入      │    │   数据读取      │              │ │
│  │  └─────────────────┘    └─────────────────┘              │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
后端WebSocket服务器
```

## 3. WebSocket中间件处理流程

```
┌─────────────────────────────────────────────────────────────┐
│                WebSocket中间件                              │
│                                                             │
│  请求进入                                                   │
│      │                                                      │
│      ▼                                                      │
│  ┌─────────────────┐                                       │
│  │  检测WebSocket   │                                       │
│  │  升级请求        │                                       │
│  └─────────────────┘                                       │
│      │                                                      │
│      ▼                                                      │
│  ┌─────────────────┐                                       │
│  │  验证Origin头    │◄───── 配置允许的源列表                │
│  │  (可选)          │                                       │
│  └─────────────────┘                                       │
│      │                                                      │
│      ▼                                                      │
│  ┌─────────────────┐                                       │
│  │  检查连接限制    │◄───── 最大连接数配置                   │
│  └─────────────────┘                                       │
│      │                                                      │
│      ▼                                                      │
│  ┌─────────────────┐                                       │
│  │  创建连接记录    │                                       │
│  │  (连接跟踪器)    │                                       │
│  └─────────────────┘                                       │
│      │                                                      │
│      ▼                                                      │
│  ┌─────────────────┐                                       │
│  │  设置上下文标记  │                                       │
│  │  (isWebSocket)  │                                       │
│  └─────────────────┘                                       │
│      │                                                      │
│      ▼                                                      │
│  请求传递给下一个中间件                                      │
└─────────────────────────────────────────────────────────────┘
```

## 4. 连接管理器架构

```
┌─────────────────────────────────────────────────────────────┐
│              WebSocket连接管理器                             │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                连接跟踪                                  │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │ 连接ID      │ │ 客户端地址  │ │ 目标URL         │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │ 连接时间    │ │ 最后活动时间│ │ 数据统计        │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                连接限制                                  │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │ 最大连接数  │ │ 单客户端限制│ │ 连接超时        │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                清理机制                                  │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │ 定期清理    │ │ 非活跃连接  │ │ 资源回收        │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                监控统计                                  │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │ 活跃连接数  │ │ 数据流量    │ │ 错误率          │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 5. 数据流向图

```
客户端WebSocket请求
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│                协议升级阶段                                  │
│                                                             │
│  1. 客户端发送HTTP请求，包含WebSocket升级头部                │
│     GET /ws HTTP/1.1                                        │
│     Upgrade: websocket                                      │
│     Connection: Upgrade                                    │
│     Sec-WebSocket-Key: ...                                  │
│     Sec-WebSocket-Version: 13                               │
│                                                             │
│  2. Toyou Proxy接收请求，检测WebSocket升级请求              │
│                                                             │
│  3. Toyou Proxy连接后端WebSocket服务器                      │
│                                                             │
│  4. 完成客户端升级握手                                      │
│     HTTP/1.1 101 Switching Protocols                        │
│     Upgrade: websocket                                      │
│     Connection: Upgrade                                    │
│     Sec-WebSocket-Accept: ...                               │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│                数据传输阶段                                  │
│                                                             │
│  ┌─────────────────┐    ┌─────────────────┐                │
│  │   客户端        │◄──►│   Toyou Proxy   │◄──►│  后端服务器  │
│  │   WebSocket     │    │   WebSocket     │    │  WebSocket  │
│  │   连接          │    │   代理          │    │  连接       │
│  └─────────────────┘    └─────────────────┘    └─────────────┘ │
│                                                             │
│  数据流向:                                                  │
│  1. 客户端 → Toyou Proxy → 后端服务器                       │
│  2. 后端服务器 → Toyou Proxy → 客户端                       │
│                                                             │
│  消息类型:                                                  │
│  - 文本消息 (Text Message)                                  │
│  - 二进制消息 (Binary Message)                              │
│  - 控制帧 (Ping/Pong/Close)                                 │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│                连接关闭阶段                                  │
│                                                             │
│  1. 任一方发送Close帧                                       │
│                                                             │
│  2. Toyou Proxy转发Close帧到另一方                           │
│                                                             │
│  3. 双方关闭连接                                             │
│                                                             │
│  4. Toyou Proxy从连接管理器中移除连接记录                    │
└─────────────────────────────────────────────────────────────┘
```

## 6. 安全处理流程

```
客户端WebSocket请求
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│                安全验证阶段                                  │
│                                                             │
│  ┌─────────────────┐                                       │
│  │  Origin验证     │                                       │
│  │  检查请求来源    │                                       │
│  └─────────────────┘                                       │
│      │                                                      │
│      ▼                                                      │
│  ┌─────────────────┐                                       │
│  │  认证验证       │                                       │
│  │  JWT令牌验证    │                                       │
│  │  会话验证       │                                       │
│  └─────────────────┘                                       │
│      │                                                      │
│      ▼                                                      │
│  ┌─────────────────┐                                       │
│  │  授权验证       │                                       │
│  │  资源访问权限    │                                       │
│  │  角色权限检查    │                                       │
│  └─────────────────┘                                       │
│      │                                                      │
│      ▼                                                      │
│  ┌─────────────────┐                                       │
│  │  速率限制       │                                       │
│  │  连接数限制     │                                       │
│  │  消息频率限制   │                                       │
│  └─────────────────┘                                       │
│      │                                                      │
│      ▼                                                      │
│  ┌─────────────────┐                                       │
│  │  WSS加密        │                                       │
│  │  SSL/TLS处理     │                                       │
│  │  证书验证       │                                       │
│  └─────────────────┘                                       │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
安全验证通过，继续WebSocket连接流程
```

## 7. 错误处理流程

```
错误发生
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│                错误检测                                      │
│                                                             │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│  │  连接错误       │ │  协议错误       │ │  网络错误       │ │
│  │  后端连接失败   │ │  协议升级失败   │ │  网络中断       │ │
│  │  连接超时       │ │  消息格式错误   │ │  读写超时       │ │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│                错误分类                                      │
│                                                             │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│  │  客户端错误     │ │  代理错误       │ │  后端错误       │ │
│  │  客户端断开     │ │  资源不足       │ │  后端服务不可用  │ │
│  │  客户端协议错误 │ │  配置错误       │ │  后端超时       │ │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│                错误处理                                      │
│                                                             │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│  │  记录错误日志   │ │  清理资源       │ │  通知客户端     │ │
│  │  错误详情       │ │  关闭连接       │ │  发送错误帧     │ │
│  │  上下文信息     │ │  释放内存       │ │  HTTP错误响应   │ │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│                错误恢复                                      │
│                                                             │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐ │
│  │  重试机制       │ │  降级处理       │ │  故障转移       │ │
│  │  连接重试       │ │  返回缓存响应   │ │  切换备用服务   │ │
│  │  指数退避       │ │  简化处理       │ │  负载均衡       │ │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 8. 监控与指标

```
┌─────────────────────────────────────────────────────────────┐
│                WebSocket监控系统                             │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                连接指标                                  │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │ 活跃连接数  │ │ 总连接数    │ │ 连接建立速率    │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │ 连接关闭速率 │ │ 平均连接时长│ │ 错误连接数      │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                流量指标                                  │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │ 接收字节数  │ │ 发送字节数  │ │ 消息数量        │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │ 平均消息大小 │ │ 峰值吞吐量  │ │ 错误率          │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                性能指标                                  │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │ 连接延迟    │ │ 消息延迟    │ │ 代理吞吐量      │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │ CPU使用率   │ │ 内存使用率  │ │ 网络带宽使用    │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                告警规则                                  │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │ 连接数阈值  │ │ 错误率阈值  │ │ 延迟阈值        │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 9. 部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                生产环境部署                                  │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                负载均衡器                                │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │  HTTP/HTTPS │ │     WSS     │ │   健康检查      │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
│                             │                                │
│                             ▼                                │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                Toyou Proxy集群                           │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │  实例1      │ │   实例2     │ │    实例N        │   │ │
│  │  │  WebSocket  │ │  WebSocket  │ │   WebSocket     │   │ │
│  │  │  代理       │ │   代理      │ │    代理         │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
│                             │                                │
│                             ▼                                │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                后端服务集群                              │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │  WebSocket  │ │  WebSocket  │ │   WebSocket     │   │ │
│  │  │  服务1      │ │   服务2     │ │    服务N        │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
│                                                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │                监控与日志系统                            │ │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐   │ │
│  │  │  指标收集    │ │   日志收集   │ │   告警系统      │   │ │
│  │  └─────────────┘ └─────────────┘ └─────────────────┘   │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

这些架构图清晰地展示了WebSocket代理功能的整体设计、数据流向、安全处理、错误处理、监控指标和部署架构，为开发团队提供了直观的参考。